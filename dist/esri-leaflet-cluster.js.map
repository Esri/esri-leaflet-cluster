{"version":3,"file":"esri-leaflet-cluster.js","sources":["../src/ClusterFeatureLayer.js"],"sourcesContent":["import { setOptions, GeoJSON, markerClusterGroup } from 'leaflet';\r\nimport { FeatureManager } from 'esri-leaflet';\r\nimport packageInfo from '../package.json';\r\nvar version = packageInfo.version;\r\nexport { version as VERSION };\r\n\r\nexport var FeatureLayer = FeatureManager.extend({\r\n\r\n  statics: {\r\n    EVENTS: 'click dblclick mouseover mouseout mousemove contextmenu popupopen popupclose',\r\n    CLUSTEREVENTS: 'clusterclick clusterdblclick clustermouseover clustermouseout clustermousemove clustercontextmenu'\r\n  },\r\n\r\n  /**\r\n   * Constructor\r\n   */\r\n\r\n  initialize: function (options) {\r\n    FeatureManager.prototype.initialize.call(this, options);\r\n\r\n    options = setOptions(this, options);\r\n\r\n    this._layers = {};\r\n    this._leafletIds = {};\r\n\r\n    this.cluster = markerClusterGroup(options);\r\n    this._key = 'c' + (Math.random() * 1e9).toString(36).replace('.', '_');\r\n\r\n    this.cluster.addEventParent(this);\r\n  },\r\n\r\n  /**\r\n   * Layer Interface\r\n   */\r\n\r\n  onAdd: function (map) {\r\n    FeatureManager.prototype.onAdd.call(this, map);\r\n    this._map.addLayer(this.cluster);\r\n  },\r\n\r\n  onRemove: function (map) {\r\n    FeatureManager.prototype.onRemove.call(this, map);\r\n    this._map.removeLayer(this.cluster);\r\n  },\r\n\r\n  /**\r\n   * Feature Management Methods\r\n   */\r\n\r\n  createNewLayer: function (geojson) {\r\n    var layer = GeoJSON.geometryToLayer(geojson, this.options);\r\n    // trap for GeoJSON without geometry\r\n    if (layer) {\r\n      layer.defaultOptions = layer.options;\r\n    }\r\n    return layer;\r\n  },\r\n\r\n  createLayers: function (features) {\r\n    var markers = [];\r\n\r\n    for (var i = features.length - 1; i >= 0; i--) {\r\n      var geojson = features[i];\r\n      var layer = this._layers[geojson.id];\r\n\r\n      if (!layer) {\r\n        layer = this.createNewLayer(geojson);\r\n        layer.feature = GeoJSON.asFeature(geojson);\r\n        layer.defaultOptions = layer.options;\r\n        layer._leaflet_id = this._key + '_' + geojson.id;\r\n\r\n        this.resetStyle(layer.feature.id);\r\n\r\n        // cache the layer\r\n        this._layers[layer.feature.id] = layer;\r\n\r\n        this._leafletIds[layer._leaflet_id] = geojson.id;\r\n\r\n        if (this.options.onEachFeature) {\r\n          this.options.onEachFeature(layer.feature, layer);\r\n        }\r\n\r\n        this.fire('createfeature', {\r\n          feature: layer.feature\r\n        });\r\n      }\r\n\r\n      // add the layer if it is within the time bounds or our layer is not time enabled\r\n      if (!this.options.timeField || (this.options.timeField && this._featureWithinTimeRange(geojson))) {\r\n        markers.push(layer);\r\n      }\r\n    }\r\n\r\n    if (markers.length) {\r\n      this.cluster.addLayers(markers);\r\n    }\r\n  },\r\n\r\n  addLayers: function (ids) {\r\n    var layersToAdd = [];\r\n    for (var i = ids.length - 1; i >= 0; i--) {\r\n      var layer = this._layers[ids[i]];\r\n      this.fire('addfeature', {\r\n        feature: layer.feature\r\n      });\r\n      layersToAdd.push(layer);\r\n    }\r\n    this.cluster.addLayers(layersToAdd);\r\n  },\r\n\r\n  removeLayers: function (ids, permanent) {\r\n    var layersToRemove = [];\r\n    for (var i = ids.length - 1; i >= 0; i--) {\r\n      var id = ids[i];\r\n      var layer = this._layers[id];\r\n      this.fire('removefeature', {\r\n        feature: layer.feature,\r\n        permanent: permanent\r\n      });\r\n      layersToRemove.push(layer);\r\n      if (this._layers[id] && permanent) {\r\n        delete this._layers[id];\r\n      }\r\n    }\r\n    this.cluster.removeLayers(layersToRemove);\r\n  },\r\n\r\n  /**\r\n   * Styling Methods\r\n   */\r\n\r\n  resetStyle: function (id) {\r\n    var layer = this._layers[id];\r\n\r\n    if (layer) {\r\n      layer.options = layer.defaultOptions;\r\n      this.setFeatureStyle(layer.feature.id, this.options.style);\r\n    }\r\n\r\n    return this;\r\n  },\r\n\r\n  setStyle: function (style) {\r\n    this.eachFeature(function (layer) {\r\n      this.setFeatureStyle(layer.feature.id, style);\r\n    }, this);\r\n    return this;\r\n  },\r\n\r\n  setFeatureStyle: function (id, style) {\r\n    var layer = this._layers[id];\r\n\r\n    if (typeof style === 'function') {\r\n      style = style(layer.feature);\r\n    }\r\n    if (layer.setStyle) {\r\n      layer.setStyle(style);\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Utility Methods\r\n   */\r\n\r\n  eachFeature: function (fn, context) {\r\n    for (var i in this._layers) {\r\n      fn.call(context, this._layers[i]);\r\n    }\r\n    return this;\r\n  },\r\n\r\n  getFeature: function (id) {\r\n    return this._layers[id];\r\n  },\r\n\r\n  // This is the same as the Layer.openPopup method except it excludes the `FeatureGroup`\r\n  // logic to work around https://github.com/Leaflet/Leaflet/issues/8761\r\n  openPopup (latlng) {\r\n    if (this._popup) {\r\n      if (this._popup._prepareOpen(latlng || this._latlng)) {\r\n        // open the popup on the map\r\n        this._popup.openOn(this._map);\r\n      }\r\n    }\r\n    return this;\r\n  },\r\n\r\n  // This is the same as the `Layer.openTooltip` method except it excludes the `FeatureGroup`\r\n  // logic to work around https://github.com/Leaflet/Leaflet/issues/8761\r\n  openTooltip (latlng) {\r\n    if (this._tooltip) {\r\n      if (this._tooltip._prepareOpen(latlng)) {\r\n        // open the tooltip on the map\r\n        this._tooltip.openOn(this._map);\r\n\r\n        if (this.getElement) {\r\n          this._setAriaDescribedByOnLayer(this);\r\n        } else if (this.eachLayer) {\r\n          this.eachLayer(this._setAriaDescribedByOnLayer, this);\r\n        }\r\n      }\r\n    }\r\n    return this;\r\n  }\r\n});\r\n\r\nexport function featureLayer (options) {\r\n  return new FeatureLayer(options);\r\n}\r\n\r\nexport default featureLayer;\r\n"],"names":["version","FeatureLayer","FeatureManager","extend","statics","EVENTS","CLUSTEREVENTS","initialize","options","prototype","call","this","setOptions","_layers","_leafletIds","cluster","markerClusterGroup","_key","Math","random","toString","replace","addEventParent","onAdd","map","_map","addLayer","onRemove","removeLayer","createNewLayer","geojson","layer","GeoJSON","geometryToLayer","defaultOptions","createLayers","features","markers","i","length","id","feature","asFeature","_leaflet_id","resetStyle","onEachFeature","fire","timeField","_featureWithinTimeRange","push","addLayers","ids","layersToAdd","removeLayers","permanent","layersToRemove","setFeatureStyle","style","setStyle","eachFeature","fn","context","getFeature","openPopup","latlng","_popup","_prepareOpen","_latlng","openOn","openTooltip","_tooltip","getElement","_setAriaDescribedByOnLayer","eachLayer","featureLayer"],"mappings":"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"}